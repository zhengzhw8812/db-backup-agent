<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>版本更新说明 - 数据库备份管理器</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .changelog-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 32px 20px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .page-header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .back-button {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            text-decoration: none;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .back-button:hover {
            background: var(--bg-secondary);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .version-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: 24px;
            margin-bottom: 20px;
        }

        .version-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .version-number {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .version-date {
            font-size: 14px;
            color: var(--text-muted);
        }

        .version-section {
            margin-bottom: 20px;
        }

        .version-section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .change-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .change-item {
            padding: 8px 0;
            padding-left: 24px;
            position: relative;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .change-item::before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--primary-color);
            font-size: 20px;
            line-height: 1;
        }

        .change-item.feature::before {
            content: "✨";
        }

        .change-item.fix::before {
            content: "🐛";
        }

        .change-item.improvement::before {
            content: "⚡";
        }

        .change-item.breaking::before {
            content: "⚠️";
        }

        .change-item.security::before {
            content: "🔒";
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
        }

        .badge-new {
            background: var(--success-light);
            color: var(--success-dark);
        }

        .badge-improved {
            background: var(--info-light);
            color: var(--info-dark);
        }

        .badge-fixed {
            background: var(--warning-light);
            color: var(--warning-dark);
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; padding: 0 20px; position: relative; z-index: 1;">
            <h1 style="margin: 0; font-size: 32px; font-weight: 700; letter-spacing: -0.5px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">数据库备份管理器</h1>
            <div style="display: flex; align-items: center; gap: 16px;">
                <span style="color: white; font-size: 14px;">你好, {{ current_user.username }}</span>
                <a href="{{ url_for('logout') }}" style="background: rgba(255, 255, 255, 0.2); color: white; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-size: 13px; font-weight: 600; transition: all 0.2s ease; backdrop-filter: blur(10px);">登出</a>
            </div>
        </div>
    </div>

    <div class="changelog-container">
        <div class="page-header">
            <h1>版本更新说明</h1>
            <a href="{{ url_for('index') }}" class="back-button">← 返回主页</a>
        </div>

        <div class="version-card">
            <div class="version-header">
                <div class="version-number">v2.4.0 <span class="badge badge-new">Latest</span></div>
                <div class="version-date">2026-01-12</div>
            </div>

            <div class="version-section">
                <div class="section-title">✨ 新功能</div>
                <ul class="change-list">
                    <li class="change-item feature">多用户数据隔离，完整的多用户支持，每个用户的备份任务、配置和历史完全独立</li>
                    <li class="change-item feature">用户注册功能，支持用户自主注册，注册成功后自动引导设置两步验证</li>
                    <li class="change-item feature">两步验证（2FA），新增 TOTP 一次性密码认证功能，增强账户安全</li>
                    <li class="change-item feature">OTP 设置向导，友好的二维码扫描和验证码输入界面</li>
                    <li class="change-item feature">安全管理页面，统一的安全设置入口，支持启用/禁用两步验证</li>
                    <li class="change-item feature">忘记密码功能，支持通过 OTP 验证重置密码，强制两步验证保障安全</li>
                    <li class="change-item feature">智能登录流程，登录页面 OTP 输入框始终显示，支持可选填写</li>
                </ul>
            </div>

            <div class="version-section">
                <div class="section-title">⚡ 优化改进</div>
                <ul class="change-list">
                    <li class="change-item improvement">注册流程优化，注册成功后自动登录并引导到 OTP 设置页面</li>
                    <li class="change-item improvement">登录页面优化，OTP 输入框始终显示，"如未设置可留空"提示</li>
                    <li class="change-item improvement">密码重置流程，提供实时的密码强度指示器，根据用户 OTP 状态自动调整流程</li>
                    <li class="change-item improvement">统一配色方案，采用统一的蓝色主题，界面更加专业美观</li>
                    <li class="change-item improvement">主页导航优化，新增"🔐 安全设置"入口</li>
                </ul>
            </div>

            <div class="version-section">
                <div class="section-title">🔒 安全增强</div>
                <ul class="change-list">
                    <li class="change-item improvement">数据库级隔离，所有业务表增加 user_id 外键，确保数据安全隔离</li>
                    <li class="change-item improvement">文件系统隔离，备份文件按用户分目录存储（/backups/user_{user_id}/）</li>
                    <li class="change-item improvement">TOTP 算法，使用标准 TOTP 算法（RFC 6238），每 30 秒生成新的 6 位验证码</li>
                    <li class="change-item improvement">密钥安全存储，密钥使用 Base32 编码存储，安全可靠</li>
                    <li class="change-item improvement">验证时间窗口，允许前后 1 个周期（30秒），避免时钟偏差问题</li>
                    <li class="change-item improvement">密码确认机制，两步验证启用/禁用操作需要密码确认，防止误操作</li>
                    <li class="change-item improvement">强制 OTP 认证，忘记密码必须通过 OTP 验证，未启用 OTP 的用户需联系管理员</li>
                </ul>
            </div>

            <div class="version-section">
                <div class="section-title">🗄️ 数据库变更</div>
                <ul class="change-list">
                    <li class="change-item improvement">新增 user_otp_config 表（OTP 配置表）</li>
                    <li class="change-item improvement">backup_history 表新增 user_id 字段</li>
                    <li class="change-item improvement">database_connections 表新增 user_id 字段</li>
                    <li class="change-item improvement">backup_schedules 表新增 user_id 字段</li>
                    <li class="change-item improvement">password_reset_tokens 表新增 user_id 字段</li>
                    <li class="change-item improvement">为所有 user_id 字段创建索引，优化查询性能</li>
                </ul>
            </div>

            <div class="version-section">
                <div class="section-title">🎯 验证器应用支持</div>
                <ul class="change-list">
                    <li class="change-item feature">Google Authenticator (iOS/Android)</li>
                    <li class="change-item feature">Microsoft Authenticator (iOS/Android)</li>
                    <li class="change-item feature">Authy (iOS/Android/Desktop)</li>
                    <li class="change-item feature">1Password, LastPass 等密码管理器的内置功能</li>
                </ul>
            </div>
        </div>

        <div class="version-card">
            <div class="version-header">
                <div class="version-number">v2.3.0</div>
                <div class="version-date">2026-01-06</div>
            </div>

            <div class="version-section">
                <div class="section-title">✨ 新功能</div>
                <ul class="change-list">
                    <li class="change-item feature">并发备份控制，添加智能备份锁机制，防止同一类型的数据库同时执行多个备份任务</li>
                    <li class="change-item feature">智能锁管理，基于数据库的持久化锁，支持自动过期（2小时）和崩溃恢复</li>
                    <li class="change-item feature">通知页面优化，改进通知设置页面的交互体验和视觉反馈</li>
                    <li class="change-item feature">调试支持，新增通知调试页面（/notifications/debug），方便排查通知配置问题</li>
                    <li class="change-item feature">锁状态查询，支持通过命令行查看当前备份锁状态</li>
                </ul>
            </div>

            <div class="version-section">
                <div class="section-title">⚡ 优化改进</div>
                <ul class="change-list">
                    <li class="change-item improvement">优化通知设置页面的 JavaScript 初始化逻辑，页面加载时正确显示配置状态</li>
                    <li class="change-item improvement">改进禁用状态的视觉反馈，输入框和测试按钮半透明，保存按钮保持正常颜色</li>
                    <li class="change-item improvement">添加多层浏览器缓存控制（HTML meta 标签 + HTTP 响应头），确保配置状态实时同步</li>
                    <li class="change-item improvement">备份锁支持内存缓存和数据库双重存储，提高性能和可靠性</li>
                    <li class="change-item improvement">锁自动过期机制，防止异常情况下锁无法释放导致备份阻塞</li>
                    <li class="change-item improvement">崩溃恢复支持，容器重启后自动检测并清理过期的锁</li>
                </ul>
            </div>

            <div class="version-section">
                <div class="section-title">🐛 问题修复</div>
                <ul class="change-list">
                    <li class="change-item fix">修复通知开关刷新后状态显示不正确的问题</li>
                    <li class="change-item fix">修复关闭通知后保存按钮无法点击的问题</li>
                    <li class="change-item fix">修复邮件/企业微信配置区域在禁用状态下的样式显示问题</li>
                    <li class="change-item fix">修复并发备份可能导致的资源冲突和数据不一致问题</li>
                    <li class="change-item fix">修复浏览器缓存导致的配置状态不同步问题</li>
                </ul>
            </div>

            <div class="version-section">
                <div class="section-title">📦 技术更新</div>
                <ul class="change-list">
                    <li class="change-item improvement">新增 backup_lock.py 模块，实现分布式锁机制</li>
                    <li class="change-item improvement">备份脚本集成锁获取和释放逻辑</li>
                    <li class="change-item improvement">Web 界面添加备份锁检查，防止重复提交备份任务</li>
                    <li class="change-item improvement">优化 CSS 样式，精确控制禁用状态下各个元素的显示效果</li>
                </ul>
            </div>

            <div class="version-section">
                <div class="section-title">📚 文档更新</div>
                <ul class="change-list">
                    <li class="change-item improvement">新增 BROWSER_CACHE_SOLUTION.md 浏览器缓存问题解决方案文档</li>
                    <li class="change-item improvement">新增 DOCKER_COMPOSE_GUIDE.md Docker Compose 使用指南</li>
                    <li class="change-item improvement">新增 CACHE_FIX_GUIDE.md 缓存修复技术说明文档</li>
                </ul>
            </div>
        </div>

        <div class="version-card">
            <div class="version-header">
                <div class="version-number">v2.2.0</div>
                <div class="version-date">2026-01-05</div>
            </div>

            <div class="version-section">
                <div class="section-title">✨ 新功能</div>
                <ul class="change-list">
                    <li class="change-item feature">数据库自动迁移功能，新增数据库版本自动检测和迁移</li>
                    <li class="change-item feature">完整性检查，应用启动时自动检查并修复数据库表和索引</li>
                    <li class="change-item feature">表结构验证，自动检测表结构是否完整，缺失或不完整的表会自动重建</li>
                    <li class="change-item feature">数据保护机制，表重建时自动备份和恢复兼容列的数据</li>
                    <li class="change-item feature">索引管理，自动创建缺失的数据库索引，优化查询性能</li>
                </ul>
            </div>

            <div class="version-section">
                <div class="section-title">⚡ 优化改进</div>
                <ul class="change-list">
                    <li class="change-item improvement">简化数据库升级流程，无需手动执行迁移脚本</li>
                    <li class="change-item improvement">支持从 v2.0.0、v2.1.0 自动升级到 v2.2.0</li>
                    <li class="change-item improvement">改进错误处理和日志输出，便于问题排查</li>
                    <li class="change-item improvement">优化迁移脚本，支持跨版本升级</li>
                    <li class="change-item improvement">增强数据库健壮性，自动修复表结构不一致问题</li>
                </ul>
            </div>

            <div class="version-section">
                <div class="section-title">🐛 问题修复</div>
                <ul class="change-list">
                    <li class="change-item fix">修复数据库表结构不完整导致的功能异常</li>
                    <li class="change-item fix">修复索引缺失导致的查询性能问题</li>
                    <li class="change-item fix">修复版本升级时表结构不一致的问题</li>
                    <li class="change-item fix">修复 backup_history 表缺少必需列的问题</li>
                    <li class="change-item fix">修复通知历史和系统日志表缺失的问题</li>
                </ul>
            </div>

            <div class="version-section">
                <div class="section-title">📦 技术更新</div>
                <ul class="change-list">
                    <li class="change-item improvement">新增 migrate_db.py 迁移脚本模块</li>
                    <li class="change-item improvement">应用启动时自动调用 ensure_v22_tables() 确保数据库完整性</li>
                    <li class="change-item improvement">实现表结构验证和自动重建机制</li>
                    <li class="change-item improvement">添加数据库索引自动创建功能</li>
                    <li class="change-item improvement">完善数据备份和恢复逻辑</li>
                </ul>
            </div>
        </div>

        <div class="version-card">
            <div class="version-header">
                <div class="version-number">v2.1.0</div>
                <div class="version-date">2026-01-05</div>
            </div>

            <div class="version-section">
                <div class="section-title">✨ 新功能</div>
                <ul class="change-list">
                    <li class="change-item feature">添加企业微信通知支持，可在备份成功/失败时接收通知</li>
                    <li class="change-item feature">添加邮件通知支持，支持 SMTP 配置和多个收件人</li>
                    <li class="change-item feature">通知类型支持配置（成功时通知、失败时通知）</li>
                    <li class="change-item feature">添加备份历史记录功能，可查看所有备份任务的执行历史</li>
                    <li class="change-item feature">添加系统日志功能，记录系统运行状态和错误信息</li>
                    <li class="change-item feature">Web 界面添加版本更新说明页面</li>
                </ul>
            </div>

            <div class="version-section">
                <div class="section-title">⚡ 优化改进</div>
                <ul class="change-list">
                    <li class="change-item improvement">优化通知消息格式，使用纯文本格式以兼容微信手机端</li>
                    <li class="change-item improvement">企业微信 Token 缓存机制优化，支持配置变更自动检测</li>
                    <li class="change-item improvement">Token 失效时自动重试机制，提高通知发送成功率</li>
                    <li class="change-item improvement">备份脚本优化，支持在后台异步发送通知，不阻塞备份流程</li>
                    <li class="change-item improvement">数据库配置管理优化，支持动态加载配置</li>
                </ul>
            </div>

            <div class="version-section">
                <div class="section-title">🐛 问题修复</div>
                <ul class="change-list">
                    <li class="change-item fix">修复企业微信通知在手机端显示"暂不支持此消息类型"的问题</li>
                    <li class="change-item fix">修复配置变更后 Token 缓存未更新导致的通知发送失败问题</li>
                    <li class="change-item fix">修复模块导入路径问题，提高容器内运行的兼容性</li>
                    <li class="change-item fix">修复日志文件路径处理问题</li>
                </ul>
            </div>
        </div>

        <div class="version-card">
            <div class="version-header">
                <div class="version-number">v2.0.0</div>
                <div class="version-date">2025-12-25</div>
            </div>

            <div class="version-section">
                <div class="section-title">✨ 重大更新 - 前端页面重构</div>
                <ul class="change-list">
                    <li class="change-item feature">全新的现代化 UI 设计，采用渐变色背景和卡片式布局</li>
                    <li class="change-item feature">响应式设计优化，支持移动端和平板设备访问</li>
                    <li class="change-item feature">添加备份文件列表页面，支持文件预览、下载和删除</li>
                    <li class="change-item feature">添加备份计划配置界面，可视化设置定时任务</li>
                    <li class="change-item feature">添加备份历史记录页面，展示所有备份任务的执行状态</li>
                    <li class="change-item feature">添加系统日志页面，可查看系统运行日志和错误信息</li>
                    <li class="change-item feature">优化表单交互体验，使用模态框替代原生弹窗</li>
                    <li class="change-item feature">添加实时状态更新，无需刷新页面即可看到最新状态</li>
                </ul>
            </div>

            <div class="version-section">
                <div class="section-title">⚡ 优化改进</div>
                <ul class="change-list">
                    <li class="change-item improvement">优化页面加载速度，减少首屏渲染时间</li>
                    <li class="change-item improvement">改进用户交互体验，添加加载状态提示和错误提示</li>
                    <li class="change-item improvement">优化备份文件管理界面，支持批量操作</li>
                    <li class="change-item improvement">改进颜色主题，提高视觉层次和可读性</li>
                    <li class="change-item improvement">优化按钮和表单样式，提供更好的视觉反馈</li>
                </ul>
            </div>

            <div class="version-section">
                <div class="section-title">🐛 问题修复</div>
                <ul class="change-list">
                    <li class="change-item fix">修复移动端菜单显示异常的问题</li>
                    <li class="change-item fix">修复表单验证逻辑错误</li>
                    <li class="change-item fix">修复页面在某些浏览器下的兼容性问题</li>
                </ul>
            </div>
        </div>

        <div class="version-card">
            <div class="version-header">
                <div class="version-number">v1.1.0</div>
                <div class="version-date">2025-12-20</div>
            </div>

            <div class="version-section">
                <div class="section-title">✨ 新功能</div>
                <ul class="change-list">
                    <li class="change-item feature">支持 MySQL 和 PostgreSQL 数据库备份</li>
                    <li class="change-item feature">支持多种备份计划（每天、每周、每月）</li>
                    <li class="change-item feature">支持手动立即备份功能</li>
                    <li class="change-item feature">支持多个数据库配置同时管理</li>
                    <li class="change-item feature">Web 界面管理，支持数据库配置的增删改查</li>
                    <li class="change-item feature">自动清理过期备份文件</li>
                    <li class="change-item feature">备份文件下载和删除功能</li>
                </ul>
            </div>
        </div>

        <div class="version-card">
            <div class="version-header">
                <div class="version-number">v1.0.0</div>
                <div class="version-date">2025-12-01</div>
            </div>

            <div class="version-section">
                <div class="section-title">✨ 初始版本</div>
                <ul class="change-list">
                    <li class="change-item feature">基础数据库备份功能</li>
                    <li class="change-item feature">Docker 容器化部署</li>
                    <li class="change-item feature">用户认证系统</li>
                    <li class="change-item feature">基本的备份文件管理</li>
                </ul>
            </div>
        </div>

        <div style="text-align: center; margin-top: 32px; color: var(--text-muted); font-size: 14px;">
            <p>数据库备份管理器 - 让数据备份更简单</p>
        </div>
    </div>
</body>
</html>
