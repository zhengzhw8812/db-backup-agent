<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“å¤‡ä»½ç®¡ç†å™¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='choices.min.css') }}">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='flatpickr.min.css') }}">
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; padding: 0 20px; position: relative; z-index: 1;">
            <h1 style="margin: 0; font-size: 32px; font-weight: 700; letter-spacing: -0.5px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">æ•°æ®åº“å¤‡ä»½ç®¡ç†å™¨</h1>
            <div style="display: flex; align-items: center; gap: 16px;">
                <a href="{{ url_for('changelog') }}" style="background: rgba(255, 255, 255, 0.15); color: white; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-size: 13px; font-weight: 600; transition: all 0.2s ease; backdrop-filter: blur(10px);">ğŸ“ æ›´æ–°æ—¥å¿—</a>
                <a href="{{ url_for('notifications') }}" style="background: rgba(255, 255, 255, 0.2); color: white; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-size: 13px; font-weight: 600; transition: all 0.2s ease; backdrop-filter: blur(10px);">ğŸ”” é€šçŸ¥è®¾ç½®</a>
                <span style="color: white; font-size: 14px;">ä½ å¥½, {{ current_user.username }}</span>
                <a href="{{ url_for('logout') }}" style="background: rgba(255, 255, 255, 0.2); color: white; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-size: 13px; font-weight: 600; transition: all 0.2s ease; backdrop-filter: blur(10px);">ç™»å‡º</a>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- ä¸»å†…å®¹åŒºåŸŸ: ä»»åŠ¡åˆ—è¡¨ -->
        <div class="tasks-section">
            <div class="section-header">
                <h2>å¤‡ä»½ä»»åŠ¡</h2>
                <button class="btn-primary" onclick="openAddModal()">æ–°å¢ä»»åŠ¡</button>
            </div>

            <div class="task-list">
                <!-- PostgreSQL ä»»åŠ¡åˆ—è¡¨ -->
                <div class="task-group">
                    <div class="task-group-header">
                        <h3>PostgreSQL æ•°æ®åº“</h3>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <span class="retention-info">
                                ğŸ“¦ ä¿ç•™ {{ config.retention_days.postgresql if config.retention_days.postgresql else 7 }} å¤©
                            </span>
                            <button class="schedule-btn" onclick="openScheduleModal('postgresql')">
                                ğŸ“… {{ humanized_schedules.postgresql }}
                            </button>
                        </div>
                    </div>
                    {% if config.postgresql %}
                        {% for db in config.postgresql %}
                        <div class="task-card" data-db-type="postgresql" data-db-id="{{ db.id }}">
                            <div class="task-info">
                                <div class="task-name">{{ db.host }}:{{ db.port }}/{{ db.db_name or 'æ‰€æœ‰æ•°æ®åº“' }}</div>
                                <div class="task-details">
                                    <span class="task-detail-item">ç”¨æˆ·: {{ db.user }}</span>
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="btn-icon btn-edit" onclick="editTask('postgresql', '{{ db.id }}')" title="ç¼–è¾‘">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M12.854 2.854a.5.5 0 00-.708 0L11 4l1.5 1.5L14 3.5a.5.5 0 000-.708l-.146-.146a.5.5 0 00-.708 0zM11 5L4 12v1.5L5.5 14l7-7L11 5z"/>
                                    </svg>
                                </button>
                                <button class="btn-icon btn-backup" onclick="backupNow('postgresql', '{{ db.id }}')" title="ç«‹å³å¤‡ä»½">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM4.5 7.5a.5.5 0 0 1 0-1h5.793L8.646 4.854a.5.5 0 1 1 .708-.708l2.5 2.5a.5.5 0 0 1 0 .708l-2.5 2.5a.5.5 0 0 1-.708-.708L10.293 7.5H4.5z"/>
                                    </svg>
                                </button>
                                <button class="btn-icon btn-delete" onclick="deleteTask('postgresql', '{{ db.id }}')" title="åˆ é™¤">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M5.5 5.5A.5.5 0 016 6v6a.5.5 0 01-1 0V6a.5.5 0 01.5-.5zm2.5 0a.5.5 0 01.5.5v6a.5.5 0 01-1 0V6a.5.5 0 01.5-.5zm3 .5a.5.5 0 00-1 0v6a.5.5 0 001 0V6z"/>
                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 01-1 1H13v9a2 2 0 01-2 2H5a2 2 0 01-2-2V4h-.5a1 1 0 01-1-1V2a1 1 0 011-1H6a1 1 0 011-1h2a1 1 0 011 1h3.5a1 1 0 011 1v1zM4.118 4L4 4.059V13a1 1 0 001 1h6a1 1 0 001-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <p>è¿˜æ²¡æœ‰é…ç½® PostgreSQL æ•°æ®åº“</p>
                            <button class="btn-secondary" onclick="openAddModal('postgresql')">æ·»åŠ ç¬¬ä¸€ä¸ªä»»åŠ¡</button>
                        </div>
                    {% endif %}
                </div>

                <!-- MySQL ä»»åŠ¡åˆ—è¡¨ -->
                <div class="task-group">
                    <div class="task-group-header">
                        <h3>MySQL æ•°æ®åº“</h3>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <span class="retention-info">
                                ğŸ“¦ ä¿ç•™ {{ config.retention_days.mysql if config.retention_days.mysql else 7 }} å¤©
                            </span>
                            <button class="schedule-btn" onclick="openScheduleModal('mysql')">
                                ğŸ“… {{ humanized_schedules.mysql }}
                            </button>
                        </div>
                    </div>
                    {% if config.mysql %}
                        {% for db in config.mysql %}
                        <div class="task-card" data-db-type="mysql" data-db-id="{{ db.id }}">
                            <div class="task-info">
                                <div class="task-name">{{ db.host }}:{{ db.port }}/{{ db.db_name or 'æ‰€æœ‰æ•°æ®åº“' }}</div>
                                <div class="task-details">
                                    <span class="task-detail-item">ç”¨æˆ·: {{ db.user }}</span>
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="btn-icon btn-edit" onclick="editTask('mysql', '{{ db.id }}')" title="ç¼–è¾‘">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M12.854 2.854a.5.5 0 00-.708 0L11 4l1.5 1.5L14 3.5a.5.5 0 000-.708l-.146-.146a.5.5 0 00-.708 0zM11 5L4 12v1.5L5.5 14l7-7L11 5z"/>
                                    </svg>
                                </button>
                                <button class="btn-icon btn-backup" onclick="backupNow('mysql', '{{ db.id }}')" title="ç«‹å³å¤‡ä»½">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM4.5 7.5a.5.5 0 0 1 0-1h5.793L8.646 4.854a.5.5 0 1 1 .708-.708l2.5 2.5a.5.5 0 0 1 0 .708l-2.5 2.5a.5.5 0 0 1-.708-.708L10.293 7.5H4.5z"/>
                                    </svg>
                                </button>
                                <button class="btn-icon btn-delete" onclick="deleteTask('mysql', '{{ db.id }}')" title="åˆ é™¤">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M5.5 5.5A.5.5 0 016 6v6a.5.5 0 01-1 0V6a.5.5 0 01.5-.5zm2.5 0a.5.5 0 01.5.5v6a.5.5 0 01-1 0V6a.5.5 0 01.5-.5zm3 .5a.5.5 0 00-1 0v6a.5.5 0 001 0V6z"/>
                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 01-1 1H13v9a2 2 0 01-2 2H5a2 2 0 01-2-2V4h-.5a1 1 0 01-1-1V2a1 1 0 011-1H6a1 1 0 011-1h2a1 1 0 011 1h3.5a1 1 0 011 1v1zM4.118 4L4 4.059V13a1 1 0 001 1h6a1 1 0 001-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <p>è¿˜æ²¡æœ‰é…ç½® MySQL æ•°æ®åº“</p>
                            <button class="btn-secondary" onclick="openAddModal('mysql')">æ·»åŠ ç¬¬ä¸€ä¸ªä»»åŠ¡</button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- å³ä¾§è¾¹æ : å¤‡ä»½æ–‡ä»¶å’Œå†å² -->
        <div class="sidebar">
            <!-- PostgreSQL å¤‡ä»½æ–‡ä»¶ -->
            <div class="card">
                <div class="card-header">
                    <h3>PostgreSQL <small style="font-size: 12px; color: var(--text-secondary); font-weight: normal;">{{ backups_by_type.postgresql|length }} ä¸ª</small></h3>
                    <button class="btn-small btn-secondary" onclick="location.reload()">åˆ·æ–°</button>
                </div>
                <div class="backup-files-list">
                    {% for backup in backups_by_type.postgresql %}
                    <div class="backup-file-item">
                        <div class="file-info">
                            <div class="file-name" title="{{ backup.name }}">{{ backup.name }}</div>
                            <div class="file-meta">è¿‡æœŸæ—¶é—´: {{ backup.delete_time }}</div>
                        </div>
                        <div class="file-actions">
                            <a href="{{ url_for('download_backup', filename=backup.name) }}" class="btn-link" title="ä¸‹è½½">ä¸‹è½½</a>
                            <button class="btn-link btn-danger" onclick="deleteBackup('{{ backup.name }}')" title="åˆ é™¤">åˆ é™¤</button>
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-state-small">
                        <p>æ²¡æœ‰ PostgreSQL å¤‡ä»½æ–‡ä»¶</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- MySQL å¤‡ä»½æ–‡ä»¶ -->
            <div class="card">
                <div class="card-header">
                    <h3>MySQL <small style="font-size: 12px; color: var(--text-secondary); font-weight: normal;">{{ backups_by_type.mysql|length }} ä¸ª</small></h3>
                    <button class="btn-small btn-secondary" onclick="location.reload()">åˆ·æ–°</button>
                </div>
                <div class="backup-files-list">
                    {% for backup in backups_by_type.mysql %}
                    <div class="backup-file-item">
                        <div class="file-info">
                            <div class="file-name" title="{{ backup.name }}">{{ backup.name }}</div>
                            <div class="file-meta">è¿‡æœŸæ—¶é—´: {{ backup.delete_time }}</div>
                        </div>
                        <div class="file-actions">
                            <a href="{{ url_for('download_backup', filename=backup.name) }}" class="btn-link" title="ä¸‹è½½">ä¸‹è½½</a>
                            <button class="btn-link btn-danger" onclick="deleteBackup('{{ backup.name }}')" title="åˆ é™¤">åˆ é™¤</button>
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-state-small">
                        <p>æ²¡æœ‰ MySQL å¤‡ä»½æ–‡ä»¶</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- å¤‡ä»½å†å² -->
            <div class="card">
                <div class="card-header">
                    <h3>å¤‡ä»½å†å² <small style="font-size: 12px; color: var(--text-secondary); font-weight: normal;">{{ backup_history|length }} æ¡</small></h3>
                </div>
                <div class="backup-history-list">
                    {% for item in backup_history %}
                    <div class="history-item">
                        <div class="history-time">{{ item.timestamp }}</div>
                        <div class="history-details">
                            <span class="history-db">{{ item.db_type }}</span>
                            <span class="history-trigger">{{ item.trigger }}</span>
                            <span class="status-badge status-{{ item.status.lower() }}">{{ item.status }}</span>
                        </div>
                        <div class="history-message" title="{{ item.message }}">
                            {{ item.message }}
                            {% if item.status == 'å¤±è´¥' and item.log_file %}
                                <a href="#" class="log-link" data-filename="{{ item.log_file }}">æŸ¥çœ‹æ—¥å¿—</a>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-state-small">
                        <p>è¿˜æ²¡æœ‰å¤‡ä»½å†å²</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢/ç¼–è¾‘ä»»åŠ¡å¼¹çª— -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeTaskModal()">&times;</span>
            <h2 id="modal-title">æ–°å¢å¤‡ä»½ä»»åŠ¡</h2>
            <form action="{{ url_for('add_db') }}" method="post" id="task-form" novalidate>
                <input type="hidden" name="edit_id" id="edit-id" value="">
                <div class="form-group">
                    <label for="db-type">æ•°æ®åº“ç±»å‹</label>
                    <select name="type" id="db-type" required>
                        <option value="postgresql">PostgreSQL</option>
                        <option value="mysql">MySQL</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="db-host">ä¸»æœºåœ°å€</label>
                    <input type="text" name="host" id="db-host" placeholder="192.168.1.100" required>
                </div>
                <div class="form-group">
                    <label for="db-port">ç«¯å£</label>
                    <input type="number" name="port" id="db-port" placeholder="5432" required>
                </div>
                <div class="form-group">
                    <label for="db-user">ç”¨æˆ·å</label>
                    <input type="text" name="user" id="db-user" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label for="db-password">å¯†ç </label>
                    <input type="password" name="password" id="db-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <div class="form-group" id="db-name-group">
                    <label for="db-name">æ•°æ®åº“å</label>
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                        <select name="db" id="db-name" style="flex: 1;">
                            <option value="">-- è¯·å…ˆè¿æ¥æœåŠ¡å™¨ --</option>
                        </select>
                        <button type="button" class="btn-small btn-secondary" onclick="loadDatabases()" title="åˆ·æ–°æ•°æ®åº“åˆ—è¡¨" id="refresh-db-btn" disabled>
                            ğŸ”„
                        </button>
                    </div>
                    <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                        å¡«å†™è¿æ¥ä¿¡æ¯åç‚¹å‡»"æµ‹è¯•è¿æ¥"æŒ‰é’®æ¥è·å–æ•°æ®åº“åˆ—è¡¨ï¼ˆå¯é€‰æ‹©"æ‰€æœ‰æ•°æ®åº“"å¤‡ä»½æ‰€æœ‰æ•°æ®åº“ï¼‰
                    </small>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeTaskModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn-secondary" onclick="testConnection()" id="test-connection-btn">
                        ğŸ”— æµ‹è¯•è¿æ¥
                    </button>
                    <button type="submit" class="btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- è®¡åˆ’è®¾ç½®å¼¹çª— -->
    <div id="schedule-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeScheduleModal()">&times;</span>
            <h2 id="schedule-modal-title">å¤‡ä»½è®¡åˆ’è®¾ç½®</h2>
            <form action="{{ url_for('save_settings') }}" method="post" id="schedule-form">
                <input type="hidden" name="db_type" id="schedule-db-type" value="">

                <div class="form-group schedule-group" id="schedule-settings-group">
                    <label for="retention-days">å¤‡ä»½ä¿ç•™å¤©æ•°</label>
                    <input type="number" name="retention_days" id="retention-days" value="7" min="1" max="365">

                    <label for="frequency" style="margin-top: 16px;">å¤‡ä»½é¢‘ç‡</label>
                    <select name="frequency" id="frequency" class="frequency-select">
                        <option value="disabled">ä»ä¸ (ä»…æ‰‹åŠ¨)</option>
                        <option value="daily">æ¯å¤©</option>
                        <option value="weekly">æ¯å‘¨</option>
                        <option value="monthly">æ¯æœˆ</option>
                    </select>
                    <div class="schedule-details" style="display: none;">
                        <input type="time" name="time" class="time-input" value="02:00">
                        <select name="weekday" class="weekday-select">
                            <option value="1">å‘¨ä¸€</option>
                            <option value="2">å‘¨äºŒ</option>
                            <option value="3">å‘¨ä¸‰</option>
                            <option value="4">å‘¨å››</option>
                            <option value="5">å‘¨äº”</option>
                            <option value="6">å‘¨å…­</option>
                            <option value="0">å‘¨æ—¥</option>
                        </select>
                        <span class="day-of-month-wrapper" style="display: none;">
                            <input type="number" name="day_of_month" class="day-of-month-input" min="1" max="31" value="1" style="width: 80px;">
                            <span style="color: var(--text-secondary); font-size: 14px; font-weight: 500; margin-left: 4px;">æ—¥</span>
                        </span>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeScheduleModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ—¥å¿—è¯¦æƒ…å¼¹çª— -->
    <div id="log-modal" class="modal">
        <div class="modal-content modal-large">
            <span class="close-button" onclick="closeLogModal()">&times;</span>
            <h2>æ—¥å¿—è¯¦æƒ…</h2>
            <pre id="log-content"></pre>
        </div>
    </div>

    <script src="{{ url_for('static', filename='choices.min.js') }}" onerror="console.error('Failed to load choices.min.js')"></script>
    <script src="{{ url_for('static', filename='flatpickr.js') }}" onerror="console.error('Failed to load flatpickr.js')"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/zh.js" onerror="console.error('Failed to load flatpickr zh.js')"></script>
    <script>
        console.log('Script is loading...');

        // è¡¨å•æäº¤éªŒè¯
        document.getElementById('task-form').addEventListener('submit', function(e) {
            const host = document.getElementById('db-host').value.trim();
            const port = document.getElementById('db-port').value.trim();
            const user = document.getElementById('db-user').value.trim();
            const password = document.getElementById('db-password').value.trim();

            if (!host || !port || !user || !password) {
                e.preventDefault();
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼ˆä¸»æœºåœ°å€ã€ç«¯å£ã€ç”¨æˆ·åã€å¯†ç ï¼‰');
                return false;
            }

            // æ•°æ®åº“åå¯ä»¥ä¸ºç©ºï¼ˆè¡¨ç¤ºæ‰€æœ‰æ•°æ®åº“ï¼‰
            return true;
        });

        // ä»»åŠ¡å¼¹çª—æ“ä½œ
        function openAddModal(defaultType) {
            document.getElementById('modal-title').textContent = 'æ–°å¢å¤‡ä»½ä»»åŠ¡';
            document.getElementById('edit-id').value = '';
            document.getElementById('task-form').reset();
            document.getElementById('db-type').value = defaultType || 'postgresql';
            document.getElementById('db-type').dispatchEvent(new Event('change'));
            document.getElementById('task-modal').style.display = 'block';
        }

        function closeTaskModal() {
            document.getElementById('task-modal').style.display = 'none';
        }

        function editTask(dbType, dbId) {
            console.log('editTask function called with:', dbType, dbId);

            // ä»åç«¯è·å–æ•°æ®åº“é…ç½®
            const url = `{{ url_for('get_db', db_type='__TYPE__', db_id='__ID__') }}`
                .replace('__TYPE__', dbType)
                .replace('__ID__', dbId);

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('è·å–æ•°æ®åº“é…ç½®å¤±è´¥: ' + data.error);
                        return;
                    }

                    // å…ˆè®¾ç½®æ•°æ®åº“ç±»å‹
                    const dbTypeSelect = document.getElementById('db-type');
                    dbTypeSelect.value = dbType;

                    // è§¦å‘ Choices.js çš„ change äº‹ä»¶æ¥æ›´æ–°æ˜¾ç¤º
                    // Choices.js éœ€è¦é€šè¿‡ç‰¹å®šçš„æ–¹å¼æ¥æ›´æ–°å€¼
                    const choicesInstance = dbTypeSelect.choicesInstance;
                    if (choicesInstance) {
                        choicesInstance.setChoiceByValue(dbType);
                    }

                    // è§¦å‘è‡ªå®šä¹‰çš„ change äº‹ä»¶æ¥æ›´æ–°ç«¯å£ç­‰å­—æ®µ
                    dbTypeSelect.dispatchEvent(new Event('change'));

                    // å¡«å……å…¶ä»–å­—æ®µ
                    document.getElementById('modal-title').textContent = 'ç¼–è¾‘å¤‡ä»½ä»»åŠ¡';
                    document.getElementById('edit-id').value = `${dbType}-${dbId}`;
                    document.getElementById('db-host').value = data.host || '';
                    document.getElementById('db-port').value = data.port || '';
                    document.getElementById('db-user').value = data.user || '';
                    document.getElementById('db-password').value = data.password || '';

                    // è®¾ç½®æ•°æ®åº“ä¸‹æ‹‰æ¡†çš„å€¼
                    const dbSelect = document.getElementById('db-name');
                    const dbName = data.db_name || '';
                    if (dbName) {
                        // åˆ›å»ºé€‰é¡¹å¹¶è®¾ç½®å€¼
                        const option = document.createElement('option');
                        option.value = dbName;
                        option.textContent = dbName;
                        dbSelect.innerHTML = '';
                        dbSelect.appendChild(option);
                        dbSelect.value = dbName;
                    } else {
                        // ç©ºå€¼ï¼Œæ˜¾ç¤º"æ‰€æœ‰æ•°æ®åº“"
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'æ‰€æœ‰æ•°æ®åº“';
                        dbSelect.innerHTML = '';
                        dbSelect.appendChild(option);
                    }

                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    document.getElementById('task-modal').style.display = 'block';
                })
                .catch(error => {
                    console.error('è·å–æ•°æ®åº“é…ç½®å‡ºé”™:', error);
                    alert('è·å–æ•°æ®åº“é…ç½®å‡ºé”™,è¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ã€‚');
                });
        }
        console.log('editTask function defined:', typeof editTask);

        function deleteTask(dbType, dbId) {
            console.log('deleteTask called with:', dbType, dbId);
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¤‡ä»½ä»»åŠ¡å—ï¼Ÿ')) {
                const url = `{{ url_for('delete_db', db_type='__TYPE__', db_id='__ID__') }}`
                    .replace('__TYPE__', dbType)
                    .replace('__ID__', dbId);
                console.log('Redirecting to:', url);
                window.location.href = url;
            }
        }

        function backupNow(dbType, dbId = null) {
            let url;
            if (dbId) {
                // å¤‡ä»½å•ä¸ªæ•°æ®åº“
                url = `{{ url_for('backup_single', db_type='__DB_TYPE__', db_id='__DB_ID__') }}`
                    .replace('__DB_TYPE__', dbType)
                    .replace('__DB_ID__', dbId);
            } else {
                // å¤‡ä»½æ‰€æœ‰æ•°æ®åº“
                url = `{{ url_for('backup_now', db_type='__DB_TYPE__') }}`.replace('__DB_TYPE__', dbType);
            }

            fetch(url, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        if (dbId) {
                            alert(`${dbType.charAt(0).toUpperCase() + dbType.slice(1)} æ•°æ®åº“å¤‡ä»½ä»»åŠ¡: ${data.task}`);
                        } else {
                            alert(`${dbType.charAt(0).toUpperCase() + dbType.slice(1)} å¤‡ä»½ä»»åŠ¡: ${data.task}`);
                        }
                    } else {
                        alert('å¤‡ä»½å¯åŠ¨å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('å¤‡ä»½è¯·æ±‚å‡ºé”™:', error);
                    alert('å¤‡ä»½è¯·æ±‚å‡ºé”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ã€‚');
                });
        }

        function deleteBackup(filename) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¤‡ä»½æ–‡ä»¶å—ï¼Ÿ')) {
                const url = `{{ url_for('delete_backup', filename='__FILE__') }}`.replace('__FILE__', filename);
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = url;
                document.body.appendChild(form);
                form.submit();
            }
        }

        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        function testConnection() {
            const dbType = document.getElementById('db-type').value;
            const host = document.getElementById('db-host').value.trim();
            const port = document.getElementById('db-port').value.trim();
            const user = document.getElementById('db-user').value.trim();
            const password = document.getElementById('db-password').value.trim();

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!host || !port || !user || !password) {
                alert('è¯·å…ˆå¡«å†™ä¸»æœºåœ°å€ã€ç«¯å£ã€ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }

            const btn = document.getElementById('test-connection-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'ğŸ”„ æµ‹è¯•ä¸­...';

            fetch('/api/test_connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    db_type: dbType,
                    host: host,
                    port: parseInt(port),
                    user: user,
                    password: password,
                    database: ''
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('âœ… ' + data.message);
                    // å¯ç”¨åˆ·æ–°æ•°æ®åº“åˆ—è¡¨æŒ‰é’®
                    document.getElementById('refresh-db-btn').disabled = false;

                    // è‡ªåŠ¨åŠ è½½æ•°æ®åº“åˆ—è¡¨
                    loadDatabases();
                } else {
                    alert('âŒ ' + data.message);
                }
            })
            .catch(error => {
                console.error('æµ‹è¯•è¿æ¥å‡ºé”™:', error);
                alert('âŒ æµ‹è¯•è¿æ¥å¤±è´¥: ' + error.message);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        }

        // åŠ è½½æ•°æ®åº“åˆ—è¡¨
        function loadDatabases() {
            const dbType = document.getElementById('db-type').value;
            const host = document.getElementById('db-host').value.trim();
            const port = document.getElementById('db-port').value.trim();
            const user = document.getElementById('db-user').value.trim();
            const password = document.getElementById('db-password').value.trim();

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!host || !port || !user || !password) {
                alert('è¯·å…ˆå¡«å†™ä¸»æœºåœ°å€ã€ç«¯å£ã€ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }

            const btn = document.getElementById('refresh-db-btn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'ğŸ”„ åŠ è½½ä¸­...';

            const dbSelect = document.getElementById('db-name');
            const currentValue = dbSelect.value;

            fetch('/api/get_databases', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    db_type: dbType,
                    host: host,
                    port: parseInt(port),
                    user: user,
                    password: password
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹
                    dbSelect.innerHTML = '';

                    if (data.databases && data.databases.length > 0) {
                        // æ·»åŠ æ•°æ®åº“é€‰é¡¹
                        data.databases.forEach(dbName => {
                            const option = document.createElement('option');
                            option.value = dbName;
                            // ç©ºå­—ç¬¦ä¸²æ˜¾ç¤ºä¸º"æ‰€æœ‰æ•°æ®åº“"
                            option.textContent = dbName === '' ? 'æ‰€æœ‰æ•°æ®åº“' : dbName;
                            dbSelect.appendChild(option);
                        });

                        // å°è¯•æ¢å¤ä¹‹å‰é€‰æ‹©çš„å€¼
                        if (currentValue && data.databases.includes(currentValue)) {
                            dbSelect.value = currentValue;
                        } else {
                            dbSelect.selectedIndex = 0;
                        }

                        alert(`âœ… æˆåŠŸåŠ è½½ ${data.databases.length} ä¸ªæ•°æ®åº“`);
                    } else {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '-- æ²¡æœ‰æ‰¾åˆ°æ•°æ®åº“ --';
                        dbSelect.appendChild(option);
                        alert('âš ï¸ æœåŠ¡å™¨ä¸Šæ²¡æœ‰æ‰¾åˆ°å¯å¤‡ä»½çš„æ•°æ®åº“');
                    }
                } else {
                    alert('âŒ ' + data.message);
                    dbSelect.innerHTML = '<option value="">-- åŠ è½½å¤±è´¥ --</option>';
                }
            })
            .catch(error => {
                console.error('åŠ è½½æ•°æ®åº“åˆ—è¡¨å‡ºé”™:', error);
                alert('âŒ åŠ è½½æ•°æ®åº“åˆ—è¡¨å¤±è´¥: ' + error.message);
                dbSelect.innerHTML = '<option value="">-- åŠ è½½å¤±è´¥ --</option>';
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            });
        }

        function openScheduleModal(dbType) {
            document.getElementById('schedule-db-type').value = dbType;
            document.getElementById('schedule-modal-title').textContent = `${dbType === 'postgresql' ? 'PostgreSQL' : 'MySQL'} å¤‡ä»½è®¡åˆ’è®¾ç½®`;

            const form = document.getElementById('schedule-form');
            const data = window.schedulesData[dbType];

            // è·å–ä¿ç•™å¤©æ•°é…ç½®
            const retentionDays = (typeof window.retentionDaysConfig === 'object' && window.retentionDaysConfig !== null)
                ? (window.retentionDaysConfig[dbType] || 7)
                : 7;

            // è®¾ç½®è¡¨å•å€¼
            form.querySelector('#retention-days').value = retentionDays;

            // è·å–é¢‘ç‡ä¸‹æ‹‰æ¡†çš„ Choices.js å®ä¾‹
            const frequencySelect = form.querySelector('#frequency');
            const choicesInstance = frequencySelect.choicesInstance;

            if (choicesInstance) {
                // ä½¿ç”¨ Choices.js çš„æ–¹æ³•æ¥è®¾ç½®å€¼
                choicesInstance.setChoiceByValue(data.frequency || 'disabled');
            } else {
                // å¦‚æœæ²¡æœ‰ Choices.js å®ä¾‹,ç›´æ¥è®¾ç½®å€¼
                frequencySelect.value = data.frequency || 'disabled';
            }

            // è§¦å‘ change äº‹ä»¶ä»¥æ›´æ–°UIæ˜¾ç¤º
            frequencySelect.dispatchEvent(new Event('change'));

            form.querySelector('.time-input').value = data.time || '02:00';
            form.querySelector('.weekday-select').value = data.weekday || '0';
            form.querySelector('.day-of-month-input').value = data.day_of_month || '1';

            document.getElementById('schedule-modal').style.display = 'block';

            // è§¦å‘ change äº‹ä»¶æ›´æ–°æ˜¾ç¤º - éœ€è¦å»¶è¿Ÿç¡®ä¿å¼¹çª—å·²æ˜¾ç¤º
            setTimeout(() => {
                form.querySelector('#frequency').dispatchEvent(new Event('change'));
            }, 50);
        }

        // æœˆä»½å¤©æ•°æç¤º
        const monthDaysWarnings = {
            29: '2æœˆä»…29å¤©ï¼ˆé—°å¹´ï¼‰',
            30: '30å¤©çš„æœˆä»½ï¼š4æœˆã€6æœˆã€9æœˆã€11æœˆ',
            31: '31å¤©çš„æœˆä»½ï¼š1æœˆã€3æœˆã€5æœˆã€7æœˆã€8æœˆã€10æœˆã€12æœˆ'
        };

        // ä¸ºæ—¥æœŸé€‰æ‹©æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            const dayOfMonthInput = document.querySelector('.day-of-month-input');
            if (dayOfMonthInput) {
                dayOfMonthInput.addEventListener('change', function() {
                    const day = parseInt(this.value);
                    if (monthDaysWarnings[day]) {
                        alert(monthDaysWarnings[day]);
                    }
                });
            }
        });

        function closeScheduleModal() {
            document.getElementById('schedule-modal').style.display = 'none';
        }

        // æ—¥å¿—å¼¹çª—æ“ä½œ
        function closeLogModal() {
            document.getElementById('log-modal').style.display = 'none';
        }

        // DOM åŠ è½½å®Œæˆåæ‰§è¡Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å®šä¹‰å…¨å±€æ•°æ® - ä½¿ç”¨å®‰å…¨çš„ JSON è¾“å‡º
            try {
                window.schedulesData = {
                    postgresql: {{ schedules_ui.postgresql | tojson | safe }},
                    mysql: {{ schedules_ui.mysql | tojson | safe }}
                };

                window.retentionDaysConfig = {{ config.retention_days | tojson | safe }};

                console.log('DOM loaded, scripts initialized');
                console.log('schedulesData:', window.schedulesData);
                console.log('retentionDaysConfig:', window.retentionDaysConfig);
            } catch (e) {
                console.error('Error initializing data:', e);
                window.schedulesData = { postgresql: {}, mysql: {} };
                window.retentionDaysConfig = { postgresql: 7, mysql: 7 };
            }

            // æ•°æ®åº“ç±»å‹æ”¹å˜å¤„ç†
            const dbTypeSelect = document.getElementById('db-type');
            if (dbTypeSelect) {
                dbTypeSelect.addEventListener('change', function() {
                    const dbPortInput = document.getElementById('db-port');
                    const dbNameGroup = document.getElementById('db-name-group');
                    const dbNameInput = document.getElementById('db-name');
                    const dbNameLabel = dbNameGroup.querySelector('label');

                    if (this.value === 'postgresql') {
                        dbPortInput.value = '5432';
                        dbNameLabel.textContent = 'æ•°æ®åº“å (PostgreSQL):';
                        dbNameInput.placeholder = 'è¦å¤‡ä»½çš„æ•°æ®åº“åç§°';
                        dbNameInput.required = true;
                    } else if (this.value === 'mysql') {
                        dbPortInput.value = '3306';
                        dbNameLabel.textContent = 'æ•°æ®åº“å (MySQL):';
                        dbNameInput.placeholder = 'ç•™ç©ºåˆ™å¤‡ä»½æ‰€æœ‰åº“';
                        dbNameInput.required = false;
                    }
                });

                // åˆå§‹åŒ–æ•°æ®åº“ç±»å‹é€‰æ‹©
                dbTypeSelect.dispatchEvent(new Event('change'));
            }

            // Choices.jsä¸‹æ‹‰é€‰æ‹© - å…ˆåˆå§‹åŒ–
            const selectElements = document.querySelectorAll('.frequency-select');
            selectElements.forEach(function(element) {
                const choices = new Choices(element, {
                    searchEnabled: false,
                    itemSelectText: 'é€‰æ‹©',
                });
                // ä¿å­˜ Choices.js å®ä¾‹å¼•ç”¨
                element.choicesInstance = choices;
            });

            // ä¸ºä»»åŠ¡å¼¹çª—çš„æ•°æ®åº“ç±»å‹ä¹Ÿåˆå§‹åŒ– Choices.js
            const dbTypeChoices = new Choices(document.getElementById('db-type'), {
                searchEnabled: false,
                itemSelectText: 'é€‰æ‹©',
                shouldSort: false
            });
            // ä¿å­˜ Choices.js å®ä¾‹å¼•ç”¨,æ–¹ä¾¿åç»­ä½¿ç”¨
            document.getElementById('db-type').choicesInstance = dbTypeChoices;

            // å¤‡ä»½è®¡åˆ’UIå¤„ç† - å®šä¹‰å‡½æ•°
            function setupScheduleUI(groupElement) {
                const frequencySelect = groupElement.querySelector('.frequency-select');
                const detailsContainer = groupElement.querySelector('.schedule-details');
                const timeInput = groupElement.querySelector('.time-input');
                const weekdaySelect = groupElement.querySelector('.weekday-select');
                const dayOfMonthWrapper = groupElement.querySelector('.day-of-month-wrapper');
                const dayOfMonthInput = groupElement.querySelector('.day-of-month-input');

                function updateVisibility() {
                    const frequency = frequencySelect.value;

                    // è·å– Choices.js å®¹å™¨ - æ¯æ¬¡éƒ½é‡æ–°è·å–ï¼Œç¡®ä¿æ‰¾åˆ°æ­£ç¡®çš„å…ƒç´ 
                    const weekdayChoices = weekdaySelect.closest('.choices');

                    console.log('updateVisibility called, frequency:', frequency);
                    console.log('weekdayChoices:', weekdayChoices);
                    console.log('timeInput:', timeInput);
                    console.log('dayOfMonthWrapper:', dayOfMonthWrapper);

                    if (frequency === 'disabled') {
                        detailsContainer.style.display = 'none';
                    } else if (frequency === 'daily') {
                        detailsContainer.style.display = 'block';
                        // æ˜¾ç¤ºæ—¶é—´ï¼Œéšè—å…¶ä»–
                        timeInput.style.display = '';
                        if (weekdayChoices) weekdayChoices.style.display = 'none';
                        if (dayOfMonthWrapper) dayOfMonthWrapper.style.display = 'none';
                    } else if (frequency === 'weekly') {
                        detailsContainer.style.display = 'block';
                        // æ˜¾ç¤ºæ—¶é—´å’Œæ˜ŸæœŸï¼Œéšè—æ—¥æœŸ
                        timeInput.style.display = '';
                        if (weekdayChoices) weekdayChoices.style.display = '';
                        if (dayOfMonthWrapper) dayOfMonthWrapper.style.display = 'none';
                    } else if (frequency === 'monthly') {
                        detailsContainer.style.display = 'block';
                        // æ˜¾ç¤ºæ—¶é—´å’Œæ—¥æœŸï¼Œéšè—æ˜ŸæœŸ
                        timeInput.style.display = '';
                        if (weekdayChoices) weekdayChoices.style.display = 'none';
                        if (dayOfMonthWrapper) dayOfMonthWrapper.style.display = '';
                    }
                }

                frequencySelect.addEventListener('change', updateVisibility);
                // åˆå§‹è°ƒç”¨å»¶è¿Ÿï¼Œç¡®ä¿ Choices.js å·²ç»åˆå§‹åŒ–
                setTimeout(updateVisibility, 100);
            }

            // å…ˆåˆå§‹åŒ– Choices.js
            // æ˜ŸæœŸä¸‹æ‹‰å•ç‹¬åˆå§‹åŒ–ï¼Œç¦ç”¨æ’åº
            const weekdaySelects = document.querySelectorAll('.weekday-select');
            weekdaySelects.forEach(function(element) {
                new Choices(element, {
                    searchEnabled: false,
                    itemSelectText: 'é€‰æ‹©',
                    shouldSort: false,
                    allowHTML: false
                });
            });

            // Choices.js åˆå§‹åŒ–å®Œæˆåï¼Œå†è®¾ç½® UI å¤„ç†
            setTimeout(function() {
                document.querySelectorAll('.schedule-group').forEach(setupScheduleUI);
            }, 150);

            // Flatpickræ—¶é—´é€‰æ‹©å™¨ - ååˆå§‹åŒ–
            flatpickr.localize(flatpickr.l10ns.zh);
            flatpickr(".time-input", {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                time_24hr: true,
                allowInput: true,
                clickOpens: true
            });

            // æ—¥å¿—æŸ¥çœ‹åŠŸèƒ½
            document.querySelectorAll('.log-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const filename = this.dataset.filename;
                    fetch(`/api/log/${filename}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                document.getElementById('log-content').textContent = `åŠ è½½æ—¥å¿—å¤±è´¥: ${data.error}`;
                            } else {
                                document.getElementById('log-content').textContent = data.content;
                            }
                            document.getElementById('log-modal').style.display = 'block';
                        })
                        .catch(error => {
                            document.getElementById('log-content').textContent = `åŠ è½½æ—¥å¿—æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯: ${error}`;
                            document.getElementById('log-modal').style.display = 'block';
                        });
                });
            });

            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            window.addEventListener('click', (event) => {
                const taskModal = document.getElementById('task-modal');
                const scheduleModal = document.getElementById('schedule-modal');
                const logModal = document.getElementById('log-modal');

                if (event.target === taskModal) {
                    taskModal.style.display = 'none';
                }
                if (event.target === scheduleModal) {
                    scheduleModal.style.display = 'none';
                }
                if (event.target === logModal) {
                    logModal.style.display = 'none';
                }
            });
        }); // DOMContentLoaded ç»“æŸ
    </script>
</body>
</html>
